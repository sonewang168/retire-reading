<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google é€£å‹• | é€€ä¼‘èµ°è®€</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #0a0f0d 0%, #1a2f1a 100%);
            min-height: 100vh;
            color: #e8efe9;
        }
        
        .header {
            background: rgba(20, 30, 25, 0.95);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-bottom: 2px solid rgba(0, 212, 170, 0.3);
        }
        
        .back-btn {
            color: #00d4aa;
            text-decoration: none;
            font-size: 1.5rem;
        }
        
        .header h1 {
            font-size: 1.3rem;
            background: linear-gradient(135deg, #00d4aa, #00ff99);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .status-card {
            background: rgba(20, 30, 25, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 2px solid rgba(0, 212, 170, 0.3);
        }
        
        .status-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .status-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        
        .status-icon.connected {
            background: linear-gradient(135deg, #00d4aa, #00ff99);
        }
        
        .status-icon.disconnected {
            background: rgba(100, 100, 100, 0.5);
        }
        
        .status-info h2 {
            font-size: 1.3rem;
            margin-bottom: 0.25rem;
        }
        
        .status-text {
            color: #7a8a7e;
            font-size: 0.9rem;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(0, 212, 170, 0.1);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #00d4aa;
        }
        
        .user-name {
            font-weight: 500;
        }
        
        .user-email {
            color: #7a8a7e;
            font-size: 0.85rem;
        }
        
        .btn {
            display: inline-block;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-google {
            background: #fff;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .btn-google:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
        }
        
        .btn-google img {
            width: 20px;
            height: 20px;
        }
        
        .btn-disconnect {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6b6b;
            border: 1px solid rgba(255, 100, 100, 0.3);
        }
        
        .btn-disconnect:hover {
            background: rgba(255, 100, 100, 0.3);
        }
        
        .features-section {
            margin-top: 2rem;
        }
        
        .features-section h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #a8c4aa;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .feature-card {
            background: rgba(0, 212, 170, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid rgba(0, 212, 170, 0.2);
        }
        
        .feature-card.disabled {
            opacity: 0.5;
        }
        
        .feature-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .feature-icon {
            font-size: 2.5rem;
        }
        
        .feature-title {
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .feature-subtitle {
            color: #7a8a7e;
            font-size: 0.85rem;
        }
        
        .feature-desc {
            color: #a8c4aa;
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        
        .feature-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .btn-feature {
            flex: 1;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            text-align: center;
            font-size: 0.85rem;
            text-decoration: none;
        }
        
        .btn-feature.primary {
            background: linear-gradient(135deg, #00d4aa, #00aa88);
            color: #0a0f0d;
        }
        
        .btn-feature.secondary {
            background: rgba(0, 212, 170, 0.1);
            color: #00d4aa;
            border: 1px solid rgba(0, 212, 170, 0.3);
        }
        
        .setup-guide {
            background: rgba(255, 200, 100, 0.1);
            border: 1px solid rgba(255, 200, 100, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .setup-guide h3 {
            color: #ffc864;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .setup-steps {
            color: #a8c4aa;
            font-size: 0.9rem;
            line-height: 1.8;
        }
        
        .setup-steps li {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .setup-steps code {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 212, 170, 0.2);
            border-top-color: #00d4aa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="back-btn">â†</a>
        <h1>ğŸ”— Google é€£å‹•è¨­å®š</h1>
    </header>
    
    <div class="container">
        <!-- é€£å‹•ç‹€æ…‹ -->
        <div class="status-card">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨æª¢æŸ¥é€£å‹•ç‹€æ…‹...</p>
            </div>
            
            <div id="status-content" style="display: none;">
                <!-- å·²é€£å‹• -->
                <div id="connected-view" style="display: none;">
                    <div class="status-header">
                        <div class="status-icon connected">âœ“</div>
                        <div class="status-info">
                            <h2>å·²é€£å‹• Google å¸³è™Ÿ</h2>
                            <p class="status-text">å¯ä»¥ä½¿ç”¨ Google ç›¸ç°¿å’Œæ–‡ä»¶åŠŸèƒ½</p>
                        </div>
                    </div>
                    
                    <div class="user-profile" id="user-profile">
                        <img src="" alt="é ­åƒ" class="user-avatar" id="user-avatar">
                        <div>
                            <div class="user-name" id="user-name"></div>
                            <div class="user-email" id="user-email"></div>
                        </div>
                    </div>
                    
                    <button class="btn btn-disconnect" onclick="disconnect()">è§£é™¤é€£å‹•</button>
                </div>
                
                <!-- æœªé€£å‹• -->
                <div id="disconnected-view" style="display: none;">
                    <div class="status-header">
                        <div class="status-icon disconnected">ğŸ”—</div>
                        <div class="status-info">
                            <h2>å°šæœªé€£å‹• Google å¸³è™Ÿ</h2>
                            <p class="status-text">é€£å‹•å¾Œå¯è‡ªå‹•åŒæ­¥ç…§ç‰‡å’Œæ—…éŠè¨˜éŒ„</p>
                        </div>
                    </div>
                    
                    <a href="/google/auth" class="btn btn-google">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                        ä½¿ç”¨ Google å¸³è™Ÿé€£å‹•
                    </a>
                </div>
            </div>
        </div>
        
        <!-- åŠŸèƒ½å¡ç‰‡ -->
        <div class="features-section">
            <h3>ğŸ“± å¯ç”¨åŠŸèƒ½</h3>
            
            <div class="feature-grid">
                <!-- Google ç›¸ç°¿ -->
                <div class="feature-card" id="feature-photos">
                    <div class="feature-header">
                        <div class="feature-icon">ğŸ“·</div>
                        <div>
                            <div class="feature-title">Google ç›¸ç°¿</div>
                            <div class="feature-subtitle">èµ°è®€åœ–é‘‘ç…§ç‰‡åº«</div>
                        </div>
                    </div>
                    <p class="feature-desc">
                        æ‰“å¡æ™‚æ‹æ”çš„ç…§ç‰‡æœƒè‡ªå‹•ä¸Šå‚³åˆ°å°ˆå±¬ç›¸ç°¿ã€Œé€€ä¼‘èµ°è®€åœ–é‘‘ã€ï¼Œæ°¸ä¹…ä¿å­˜ä½ çš„æ¢éšªå›æ†¶ã€‚
                    </p>
                    <div class="feature-actions">
                        <a href="#" class="btn-feature primary" id="btn-open-album" onclick="openAlbum()">é–‹å•Ÿç›¸ç°¿</a>
                        <a href="#" class="btn-feature secondary" onclick="viewPhotos()">ç€è¦½ç…§ç‰‡</a>
                    </div>
                </div>
                
                <!-- Google æ–‡ä»¶ -->
                <div class="feature-card" id="feature-docs">
                    <div class="feature-header">
                        <div class="feature-icon">ğŸ“</div>
                        <div>
                            <div class="feature-title">Google æ–‡ä»¶</div>
                            <div class="feature-subtitle">æ—…éŠæ—¥èªŒè¨˜éŒ„</div>
                        </div>
                    </div>
                    <p class="feature-desc">
                        æ¯æ¬¡æ‰“å¡çš„å¿ƒå¾—ç­†è¨˜æœƒè‡ªå‹•æ•´ç†åˆ°ã€Œé€€ä¼‘èµ°è®€æ—…éŠæ—¥èªŒã€ï¼Œåœ–æ–‡ä¸¦èŒ‚è¨˜éŒ„ä½ çš„æ—…ç¨‹é»æ»´ã€‚
                    </p>
                    <div class="feature-actions">
                        <a href="#" class="btn-feature primary" id="btn-open-doc" onclick="openDoc()">é–‹å•Ÿæ–‡ä»¶</a>
                        <a href="#" class="btn-feature secondary" onclick="testEntry()">æ¸¬è©¦å¯«å…¥</a>
                    </div>
                </div>
                
                <!-- ImgBB åœ–ç‰‡è¨—ç®¡ -->
                <div class="feature-card" id="feature-imgbb">
                    <div class="feature-header">
                        <div class="feature-icon">ğŸ–¼ï¸</div>
                        <div>
                            <div class="feature-title">ImgBB åœ–ç‰‡è¨—ç®¡</div>
                            <div class="feature-subtitle" id="imgbb-status-text">æª¢æŸ¥ä¸­...</div>
                        </div>
                    </div>
                    <p class="feature-desc">
                        ç…§ç‰‡æœƒä¸Šå‚³åˆ° ImgBB å–å¾—å…¬é–‹ URLï¼Œæ‰èƒ½åœ¨ Google æ–‡ä»¶ä¸­é¡¯ç¤ºå¯¦éš›åœ–ç‰‡ï¼ˆåœ–æ–‡ä¸¦èŒ‚ï¼‰ã€‚
                    </p>
                    <div class="feature-actions">
                        <a href="#" class="btn-feature secondary" onclick="testImgbb()">æ¸¬è©¦ä¸Šå‚³</a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¨­å®šæŒ‡å— -->
        <div class="setup-guide">
            <h3>âš™ï¸ é–‹ç™¼è€…è¨­å®šæŒ‡å—</h3>
            <ol class="setup-steps">
                <li>å‰å¾€ <a href="https://console.cloud.google.com" target="_blank" style="color: #00d4aa;">Google Cloud Console</a></li>
                <li>å»ºç«‹å°ˆæ¡ˆä¸¦å•Ÿç”¨ <code>Google Photos Library API</code> å’Œ <code>Google Docs API</code></li>
                <li>å»ºç«‹ OAuth 2.0 ç”¨æˆ¶ç«¯ IDï¼ˆç¶²é æ‡‰ç”¨ç¨‹å¼ï¼‰</li>
                <li>æ–°å¢æˆæ¬Šé‡æ–°å°å‘ URIï¼š<code>https://your-domain.com/google/callback</code></li>
                <li>å‰å¾€ <a href="https://api.imgbb.com/" target="_blank" style="color: #00d4aa;">ImgBB API</a> å–å¾— API Keyï¼ˆç”¨æ–¼åœ–æ–‡ä¸¦èŒ‚ï¼‰</li>
                <li>åœ¨ Railway ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®šï¼š
                    <ul>
                        <li><code>GOOGLE_CLIENT_ID</code></li>
                        <li><code>GOOGLE_CLIENT_SECRET</code></li>
                        <li><code>GOOGLE_REDIRECT_URI</code></li>
                        <li><code>IMGBB_API_KEY</code> â¬…ï¸ åœ–æ–‡ä¸¦èŒ‚å¿…é ˆ</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>
    
    <script>
        let isConnected = false;
        let albumUrl = '';
        let docUrl = '';
        
        // æª¢æŸ¥é€£å‹•ç‹€æ…‹
        async function checkStatus() {
            document.getElementById('loading').classList.add('show');
            
            try {
                const response = await fetch('/google/status');
                const data = await response.json();
                
                document.getElementById('loading').classList.remove('show');
                document.getElementById('status-content').style.display = 'block';
                
                if (data.connected) {
                    isConnected = true;
                    document.getElementById('connected-view').style.display = 'block';
                    document.getElementById('disconnected-view').style.display = 'none';
                    
                    // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
                    if (data.user) {
                        if (data.user.picture) {
                            document.getElementById('user-avatar').src = data.user.picture;
                        }
                        document.getElementById('user-name').textContent = data.user.name || '';
                        document.getElementById('user-email').textContent = data.user.email || '';
                    }
                    
                    // å•Ÿç”¨åŠŸèƒ½å¡ç‰‡
                    document.getElementById('feature-photos').classList.remove('disabled');
                    document.getElementById('feature-docs').classList.remove('disabled');
                    
                    // é å…ˆå–å¾—ç›¸ç°¿å’Œæ–‡ä»¶é€£çµ
                    loadAlbumAndDoc();
                } else {
                    isConnected = false;
                    document.getElementById('connected-view').style.display = 'none';
                    document.getElementById('disconnected-view').style.display = 'block';
                    
                    // åœç”¨åŠŸèƒ½å¡ç‰‡
                    document.getElementById('feature-photos').classList.add('disabled');
                    document.getElementById('feature-docs').classList.add('disabled');
                }
                
                // æª¢æŸ¥ ImgBB ç‹€æ…‹
                checkImgbbStatus();
            } catch (error) {
                console.error('æª¢æŸ¥ç‹€æ…‹å¤±æ•—:', error);
                document.getElementById('loading').classList.remove('show');
                document.getElementById('status-content').style.display = 'block';
                document.getElementById('disconnected-view').style.display = 'block';
            }
        }
        
        // è¼‰å…¥ç›¸ç°¿å’Œæ–‡ä»¶è³‡è¨Š
        async function loadAlbumAndDoc() {
            try {
                // å–å¾—ç›¸ç°¿
                const albumRes = await fetch('/google/album');
                const album = await albumRes.json();
                if (album.productUrl) {
                    albumUrl = album.productUrl;
                }
                
                // å–å¾—æ–‡ä»¶
                const docRes = await fetch('/google/doc');
                const doc = await docRes.json();
                if (doc.url) {
                    docUrl = doc.url;
                }
            } catch (error) {
                console.error('è¼‰å…¥è³‡æºå¤±æ•—:', error);
            }
        }
        
        // è§£é™¤é€£å‹•
        async function disconnect() {
            if (!confirm('ç¢ºå®šè¦è§£é™¤ Google é€£å‹•å—ï¼Ÿ')) return;
            
            try {
                await fetch('/google/disconnect');
                location.reload();
            } catch (error) {
                alert('è§£é™¤é€£å‹•å¤±æ•—');
            }
        }
        
        // é–‹å•Ÿç›¸ç°¿
        function openAlbum() {
            if (!isConnected) {
                alert('è«‹å…ˆé€£å‹• Google å¸³è™Ÿ');
                return;
            }
            if (albumUrl) {
                window.open(albumUrl, '_blank');
            } else {
                alert('ç›¸ç°¿é€£çµå°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }
        
        // é–‹å•Ÿæ–‡ä»¶
        function openDoc() {
            if (!isConnected) {
                alert('è«‹å…ˆé€£å‹• Google å¸³è™Ÿ');
                return;
            }
            if (docUrl) {
                window.open(docUrl, '_blank');
            } else {
                alert('æ–‡ä»¶é€£çµå°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }
        
        // ç€è¦½ç…§ç‰‡
        async function viewPhotos() {
            if (!isConnected) {
                alert('è«‹å…ˆé€£å‹• Google å¸³è™Ÿ');
                return;
            }
            
            try {
                const response = await fetch('/google/album/photos');
                const data = await response.json();
                
                if (data.mediaItems && data.mediaItems.length > 0) {
                    alert(`ç›¸ç°¿ä¸­æœ‰ ${data.mediaItems.length} å¼µç…§ç‰‡`);
                } else {
                    alert('ç›¸ç°¿ä¸­é‚„æ²’æœ‰ç…§ç‰‡');
                }
            } catch (error) {
                alert('è¼‰å…¥ç…§ç‰‡å¤±æ•—');
            }
        }
        
        // æ¸¬è©¦å¯«å…¥æ–‡ä»¶
        async function testEntry() {
            if (!isConnected) {
                alert('è«‹å…ˆé€£å‹• Google å¸³è™Ÿ');
                return;
            }
            
            try {
                const response = await fetch('/google/doc/entry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        spot_name: 'æ¸¬è©¦æ™¯é»',
                        location: 'å°ç£æŸè™•',
                        notes: 'é€™æ˜¯ä¸€ç­†æ¸¬è©¦è¨˜éŒ„ï¼Œç¢ºèª Google æ–‡ä»¶æ•´åˆåŠŸèƒ½æ­£å¸¸é‹ä½œï¼'
                    })
                });
                
                const result = await response.json();
                
                if (result.doc_url) {
                    if (confirm('æ¸¬è©¦å¯«å…¥æˆåŠŸï¼æ˜¯å¦é–‹å•Ÿæ–‡ä»¶æŸ¥çœ‹ï¼Ÿ')) {
                        window.open(result.doc_url, '_blank');
                    }
                } else {
                    alert('å¯«å…¥å¤±æ•—ï¼š' + JSON.stringify(result));
                }
            } catch (error) {
                alert('æ¸¬è©¦å¯«å…¥å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // æª¢æŸ¥ ImgBB ç‹€æ…‹
        async function checkImgbbStatus() {
            try {
                const response = await fetch('/google/imgbb/status');
                const data = await response.json();
                
                const statusText = document.getElementById('imgbb-status-text');
                const featureCard = document.getElementById('feature-imgbb');
                
                if (data.configured) {
                    statusText.textContent = 'âœ… å·²è¨­å®š';
                    statusText.style.color = '#00d4aa';
                    featureCard.classList.remove('disabled');
                } else {
                    statusText.textContent = 'âŒ æœªè¨­å®š IMGBB_API_KEY';
                    statusText.style.color = '#ff6b6b';
                    featureCard.classList.add('disabled');
                }
            } catch (error) {
                console.error('æª¢æŸ¥ ImgBB ç‹€æ…‹å¤±æ•—:', error);
                document.getElementById('imgbb-status-text').textContent = 'æª¢æŸ¥å¤±æ•—';
            }
        }
        
        // æ¸¬è©¦ ImgBB ä¸Šå‚³
        async function testImgbb() {
            const statusText = document.getElementById('imgbb-status-text');
            statusText.textContent = 'ğŸ”„ æ¸¬è©¦ä¸­...';
            
            try {
                const response = await fetch('/google/imgbb/test', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    statusText.textContent = 'âœ… æ¸¬è©¦æˆåŠŸ';
                    statusText.style.color = '#00d4aa';
                    alert('ImgBB ä¸Šå‚³æ¸¬è©¦æˆåŠŸï¼\n\nåœ–ç‰‡ URLï¼š\n' + result.url);
                } else {
                    statusText.textContent = 'âŒ ' + (result.error || 'æ¸¬è©¦å¤±æ•—');
                    statusText.style.color = '#ff6b6b';
                    alert('ImgBB æ¸¬è©¦å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                statusText.textContent = 'âŒ æ¸¬è©¦å¤±æ•—';
                statusText.style.color = '#ff6b6b';
                alert('ImgBB æ¸¬è©¦å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç‹€æ…‹
        checkStatus();
    </script>
</body>
</html>
